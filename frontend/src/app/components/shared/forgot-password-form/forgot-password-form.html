<!-- Vista cuando NO se ha enviado el email -->
<form
  *ngIf="!emailSent()"
  [formGroup]="forgotForm"
  class="forgot-password-form"
  (ngSubmit)="onSubmit()"
  method="post"
  novalidate>

  <fieldset class="forgot-password-form__fieldset">
    <legend class="forgot-password-form__legend">Recupera tu contraseña</legend>

    <!-- Descripción -->
    <p class="forgot-password-form__description">
      Introduce tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.
    </p>

    <!-- Campo de correo electrónico -->
    <div class="forgot-password-form__field">
      <label for="forgot-email" class="forgot-password-form__label">
        Correo electrónico
        <span class="forgot-password-form__required" aria-label="Campo requerido">*</span>
      </label>
      <input
        id="forgot-email"
        type="email"
        name="email"
        placeholder="tu@email.com"
        [formControl]="emailControl"
        class="forgot-password-form__input"
        [class.forgot-password-form__input--error]="emailControl?.invalid && emailControl?.touched"
        [attr.aria-invalid]="emailControl?.invalid && emailControl?.touched"
        [attr.aria-describedby]="(emailControl?.invalid && emailControl?.touched) ? 'email-error' : 'email-help'"
        autocomplete="email" />

      <!-- Mensaje de error - Email requerido -->
      @if (emailControl?.hasError('required') && emailControl?.touched) {
        <p
          id="email-error"
          class="forgot-password-form__error"
          role="alert">
          El correo electrónico es requerido
        </p>
      }

      <!-- Mensaje de error - Email inválido -->
      @if (emailControl?.hasError('email') && emailControl?.touched) {
        <p
          id="email-error"
          class="forgot-password-form__error"
          role="alert">
          Correo inválido. Debe tener @ y dominio válido (ej: email@dominio.es)
        </p>
      }

      <!-- Texto de ayuda -->
      @if (!(emailControl?.invalid && emailControl?.touched)) {
        <p
          id="email-help"
          class="forgot-password-form__help">
          Usa el mismo correo con el que te registraste
        </p>
      }
    </div>
  </fieldset>

  <!-- Botón de submit -->
  <button
    type="submit"
    class="forgot-password-form__submit"
    [disabled]="forgotForm.invalid || isSubmitting()"
    [attr.aria-busy]="isSubmitting()">
    {{ isSubmitting() ? 'ENVIANDO...' : 'ENVIAR ENLACE' }}
  </button>

  <!-- Link de volver al login -->
  <div class="forgot-password-form__footer">
    <p class="forgot-password-form__footer-text">
      <a href="#" class="forgot-password-form__link">← Volver al inicio de sesión</a>
    </p>
  </div>
</form>

<!-- Vista de confirmación cuando se ha enviado el email -->
<div *ngIf="emailSent()" class="forgot-password-form forgot-password-form--success">
  <div class="forgot-password-form__success-content">
    <!-- Icono de éxito -->
    <div class="forgot-password-form__success-icon" aria-hidden="true">✓</div>

    <!-- Título -->
    <h2 class="forgot-password-form__success-title">
      ¡Revisa tu correo!
    </h2>

    <!-- Mensaje -->
    <p class="forgot-password-form__success-message">
      Hemos enviado un enlace de recuperación a <strong>{{ forgotForm.get('email')?.value }}</strong>
    </p>

    <p class="forgot-password-form__success-info">
      El enlace expirará en 1 hora. Si no recibes el correo, revisa tu carpeta de spam.
    </p>

    <!-- Botón para enviar otro correo -->
    <button
      type="button"
      class="forgot-password-form__submit forgot-password-form__submit--secondary"
      (click)="sendAnother()">
      ENVIAR OTRO CORREO
    </button>

    <!-- Link de volver al login -->
    <div class="forgot-password-form__footer">
      <p class="forgot-password-form__footer-text">
        <a href="#" class="forgot-password-form__link">← Volver al inicio de sesión</a>
      </p>
    </div>
  </div>
</div>
