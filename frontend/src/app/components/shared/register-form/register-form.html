<form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="register-form" method="post" novalidate>
  <!-- Fieldset 1: Información de cuenta -->
  <fieldset class="register-form__fieldset">
    <legend class="register-form__legend">Crea tu cuenta</legend>

    <!-- Campo de nombre de usuario -->
    <div class="register-form__field">
      <label for="register-username" class="register-form__label">
        Nombre de usuario
        <span class="register-form__required" aria-label="Campo requerido">*</span>
      </label>
      <input
        id="register-username"
        type="text"
        [formControl]="usernameControl"
        placeholder="tunombredeusuario"
        class="register-form__input"
        [class.register-form__input--error]="usernameControl?.invalid && usernameControl?.touched"
        [attr.aria-invalid]="usernameControl?.invalid && usernameControl?.touched"
        [attr.aria-describedby]="(usernameControl?.invalid && usernameControl?.touched) ? 'username-error' : 'username-help'"
        autocomplete="username" />

      <!-- Mensaje de error -->
      @if (usernameControl?.invalid && usernameControl?.touched) {
      <p
        id="username-error"
        class="register-form__error"
        role="alert">
        @if (usernameControl?.hasError('required')) {
          Username es requerido
        }
        @if (usernameControl?.hasError('minlength')) {
          Mínimo 3 caracteres
        }
        @if (usernameControl?.hasError('maxlength')) {
          Máximo 20 caracteres
        }
        @if (usernameControl?.hasError('pattern')) {
          Solo letras, números y guiones bajos
        }
      </p>
      }

      <!-- Texto de ayuda -->
      @if (!usernameControl?.invalid || !usernameControl?.touched) {
      <p
        id="username-help"
        class="register-form__help">
        Este será tu nombre visible en Discs & Records
      </p>
      }
    </div>

    <!-- Campo de correo electrónico -->
    <div class="register-form__field">
      <label for="register-email" class="register-form__label">
        Correo electrónico
        <span class="register-form__required" aria-label="Campo requerido">*</span>
      </label>
      <input
        id="register-email"
        type="email"
        [formControl]="emailControl"
        placeholder="tu@email.com"
        class="register-form__input"
        [class.register-form__input--error]="emailControl?.invalid && emailControl?.touched"
        [attr.aria-invalid]="emailControl?.invalid && emailControl?.touched"
        [attr.aria-describedby]="(emailControl?.invalid && emailControl?.touched) ? 'email-error' : 'email-help'"
        autocomplete="email" />

      <!-- Mensaje de error -->
      @if (emailControl?.invalid && emailControl?.touched) {
      <p
        id="email-error"
        class="register-form__error"
        role="alert">
        @if (emailControl?.hasError('required')) {
          Email es requerido
        }
        @if (emailControl?.hasError('email')) {
          Email debe ser válido
        }
      </p>
      }

      <!-- Texto de ayuda -->
      @if (!emailControl?.invalid || !emailControl?.touched) {
      <p
        id="email-help"
        class="register-form__help">
        Lo usaremos para enviarte actualizaciones de tus álbumes favoritos
      </p>
      }
    </div>
  </fieldset>

  <!-- Fieldset 2: Seguridad -->
  <fieldset class="register-form__fieldset">
    <legend class="register-form__legend">Seguridad</legend>

    <!-- Campo de contraseña -->
    <div class="register-form__field">
      <label for="register-password" class="register-form__label">
        Contraseña
        <span class="register-form__required" aria-label="Campo requerido">*</span>
      </label>
      <input
        id="register-password"
        type="password"
        [formControl]="passwordControl"
        placeholder="••••••••"
        class="register-form__input"
        [class.register-form__input--error]="passwordControl?.invalid && passwordControl?.touched"
        [attr.aria-invalid]="passwordControl?.invalid && passwordControl?.touched"
        [attr.aria-describedby]="(passwordControl?.invalid && passwordControl?.touched) ? 'password-error' : 'password-help'"
        autocomplete="new-password" />

      <!-- Mensaje de error -->
      @if (passwordControl?.invalid && passwordControl?.touched) {
      <span
        id="password-error"
        class="register-form__error"
        role="alert">
        @if (passwordControl?.hasError('required')) {
          Contraseña es requerida
        }
        @if (passwordControl?.hasError('minlength')) {
          Mínimo 8 caracteres
        }
        @if (passwordControl?.hasError('pattern')) {
          Debe contener mayúscula y carácter especial (!@#$%...)
        }
      </span>
      }

      <!-- Texto de ayuda -->
      @if (!passwordControl?.invalid || !passwordControl?.touched) {
      <span
        id="password-help"
        class="register-form__help">
        Mínimo 8 caracteres para proteger tu cuenta
      </span>
      }
    </div>

    <!-- Campo de confirmación de contraseña -->
    <div class="register-form__field">
      <label for="register-confirm-password" class="register-form__label">
        Confirmar contraseña
        <span class="register-form__required" aria-label="Campo requerido">*</span>
      </label>
      <input
        id="register-confirm-password"
        type="password"
        [formControl]="confirmPasswordControl"
        placeholder="••••••••"
        class="register-form__input"
        [class.register-form__input--error]="(confirmPasswordControl.invalid || registerForm.hasError('passwordMismatch')) && confirmPasswordControl.touched"
        [attr.aria-invalid]="(confirmPasswordControl.invalid || registerForm.hasError('passwordMismatch')) && confirmPasswordControl.touched"
        [attr.aria-describedby]="((confirmPasswordControl.invalid || registerForm.hasError('passwordMismatch')) && confirmPasswordControl.touched) ? 'confirm-password-error' : 'confirm-password-help'"
        autocomplete="new-password" />

      <!-- Mensaje de error -->
      @if ((confirmPasswordControl.invalid || registerForm.hasError('passwordMismatch')) && confirmPasswordControl.touched) {
      <span
        id="confirm-password-error"
        class="register-form__error"
        role="alert">
        @if (confirmPasswordControl.hasError('required')) {
          Confirma tu contraseña
        }
        @if (registerForm.hasError('passwordMismatch')) {
          Las contraseñas no coinciden
        }
      </span>
      }

      <!-- Texto de ayuda -->
      @if ((!confirmPasswordControl.invalid && !registerForm.hasError('passwordMismatch')) || !confirmPasswordControl.touched) {
      <span
        id="confirm-password-help"
        class="register-form__help">
        Vuelve a escribir tu contraseña
      </span>
      }
    </div>
  </fieldset>

  <!-- Botón de submit -->
  <button
    type="submit"
    class="register-form__submit"
    [disabled]="registerForm.invalid || isSubmitting()"
    [attr.aria-busy]="isSubmitting()">
    {{ isSubmitting() ? 'CREANDO CUENTA...' : 'CREAR CUENTA' }}
  </button>

  <!-- Link de inicio de sesión -->
  <div class="register-form__footer">
    <p class="register-form__footer-text">
      ¿Ya tienes cuenta?
      <a href="#" class="register-form__link">Inicia sesión</a>
    </p>
  </div>
</form>
