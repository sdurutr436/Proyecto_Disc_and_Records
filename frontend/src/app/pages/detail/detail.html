<div class="detail">
  @if (item(); as itemData) {
    <div class="detail__container">

      <!-- COLUMNA IZQUIERDA: INFO DEL 츼LBUM/ARTISTA/CANCI칍N (1/3) -->
      <aside class="detail__sidebar">
        <div class="detail-card">
          <!-- Cover del 치lbum -->
          <div class="detail-card__cover">
            @if ('coverUrl' in itemData) {
              <img
                [src]="itemData.coverUrl"
                [alt]="itemData.title"
                class="detail-card__image"
              />
            } @else {
              <img
                [src]="$any(itemData).photoUrl"
                [alt]="$any(itemData).name"
                class="detail-card__image"
              />
            }
          </div>

          <!-- Info b치sica -->
          <div class="detail-card__info">
            @if ('title' in itemData) {
              <h1 class="detail-card__title">{{ itemData.title }}</h1>
            } @else {
              <h1 class="detail-card__title">{{ $any(itemData).name }}</h1>
            }

            @if ('artist' in itemData && 'artistId' in itemData) {
              <p class="detail-card__artist" (click)="goToArtist(itemData.artistId)">
                {{ itemData.artist }}
              </p>
            }

            <!-- Rating promedio (solo para 치lbumes y canciones) -->
            @if ('averageRating' in itemData && 'totalReviews' in itemData) {
              <div class="detail-card__rating">
                <app-rating
                  [rating]="itemData.averageRating"
                  [showValue]="true"
                  size="medium"
                />
                <p class="detail-card__reviews-count">
                  {{ itemData.totalReviews }} rese침as
                </p>
              </div>
            }

            <!-- Detalles para 치lbum -->
            @if ('tracks' in itemData && 'label' in itemData && 'duration' in itemData) {
              <div class="detail-card__details">
                <div class="detail-item">
                  <span class="detail-item__label">A침o</span>
                  <span class="detail-item__value">{{ itemData.releaseYear }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">G칠nero</span>
                  <span class="detail-item__value">{{ itemData.genre }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">Canciones</span>
                  <span class="detail-item__value">{{ itemData.tracks }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">Duraci칩n</span>
                  <span class="detail-item__value">{{ itemData.duration }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">Sello</span>
                  <span class="detail-item__value">{{ itemData.label }}</span>
                </div>
              </div>
            }

            <!-- Detalles para artista -->
            @if ('albums' in itemData && 'monthlyListeners' in itemData && 'activeYears' in itemData) {
              <div class="detail-card__details">
                <div class="detail-item">
                  <span class="detail-item__label">A침os activo</span>
                  <span class="detail-item__value">{{ $any(itemData).activeYears }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">G칠nero</span>
                  <span class="detail-item__value">{{ $any(itemData).genre }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">츼lbumes</span>
                  <span class="detail-item__value">{{ $any(itemData).albums }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">Oyentes mensuales</span>
                  <span class="detail-item__value">{{ $any(itemData).monthlyListeners | number }}</span>
                </div>
              </div>
            }

            <!-- Detalles para canci칩n -->
            @if ('album' in itemData && 'albumId' in itemData) {
              <div class="detail-card__details">
                <div class="detail-item">
                  <span class="detail-item__label">츼lbum</span>
                  <span class="detail-item__value">{{ itemData.album }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">A침o</span>
                  <span class="detail-item__value">{{ itemData.releaseYear }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">G칠nero</span>
                  <span class="detail-item__value">{{ itemData.genre }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-item__label">Duraci칩n</span>
                  <span class="detail-item__value">{{ itemData.duration }}</span>
                </div>
              </div>
            }

            <!-- Descripci칩n/Bio -->
            <div class="detail-card__description">
              @if ('description' in itemData && itemData.description) {
                <p>{{ itemData.description }}</p>
              } @else if ('bio' in itemData && itemData.bio) {
                <p>{{ itemData.bio }}</p>
              }
            </div>
          </div>
        </div>
      </aside>

      <!-- COLUMNA DERECHA: RESE칌AS Y PUNTUACI칍N (2/3) -->
      <main class="detail__content">

        <!-- Navegaci칩n interna por secciones (usa fragments) -->
        <nav class="detail__nav">
          <app-button
            variant="ghost"
            size="md"
            (clicked)="navigateToSection('info')"
            class="detail__nav-item"
          >
            Informaci칩n
          </app-button>
          <app-button
            variant="ghost"
            size="md"
            (clicked)="navigateToSection('tracks')"
            class="detail__nav-item"
          >
            Canciones
          </app-button>
          <app-button
            variant="ghost"
            size="md"
            (clicked)="navigateToSection('reviews')"
            class="detail__nav-item"
          >
            Rese침as
          </app-button>
          <app-button
            variant="secondary"
            size="md"
            (clicked)="shareReviewsLink()"
            class="detail__nav-item detail__nav-item--share"
          >
            游댕 Compartir
          </app-button>
        </nav>

        <!-- SECCI칍N: LISTA DE CANCIONES -->
        <section id="tracks" class="tracklist-section">
          <h2 class="section-title">Lista de canciones</h2>
          <app-accordion
            [items]="tracklistAccordionItems()"
            mode="single">
          </app-accordion>
        </section>

        <!-- SECCI칍N: TU PUNTUACI칍N -->
        <section id="info" class="rating-section">
          <h2 class="section-title">Tu puntuaci칩n</h2>

          <div class="rating-input">
            <app-rating
              [rating]="userRating()"
              [interactive]="true"
              size="large"
              (ratingChange)="setRating($event)"
            />

            @if (hasUserRated()) {
              <p class="rating-input__message">
                Has puntuado este 치lbum con {{ userRating() }} estrella{{ userRating() !== 1 ? 's' : '' }}
              </p>
            } @else {
              <p class="rating-input__message">
                Haz clic en una estrella para puntuar
              </p>
            }
          </div>
        </section>

        <!-- SECCI칍N: ESCRIBIR RESE칌A -->
        <section class="review-form-section">
          @if (!isWritingReview()) {
            <app-button
              variant="primary"
              size="lg"
              [fullWidth]="true"
              (clicked)="toggleReviewForm()"
            >
              Escribir una rese침a
            </app-button>
          } @else {
            <div class="review-form">
              <h3 class="review-form__title">Escribe tu rese침a</h3>

              <app-form-textarea
                [(ngModel)]="reviewText"
                placeholder="Comparte tu opini칩n sobre este 치lbum (m칤nimo 50 caracteres)..."
                [rows]="6"
              ></app-form-textarea>

              <div class="review-form__footer">
                <span class="review-form__counter">
                  {{ reviewText().length }} caracteres
                  @if (reviewText().length < 50) {
                    <span class="review-form__counter--warning">
                      (m칤nimo 50)
                    </span>
                  }
                </span>

                <div class="review-form__actions">
                  <app-button
                    variant="secondary"
                    size="md"
                    (clicked)="cancelReview()"
                  >
                    Cancelar
                  </app-button>
                  <app-button
                    variant="primary"
                    size="md"
                    [disabled]="!canSubmitReview()"
                    (clicked)="submitReview()"
                  >
                    Publicar rese침a
                  </app-button>
                </div>
              </div>
            </div>
          }
        </section>

        <!-- SECCI칍N: LISTA DE RESE칌AS -->
        <section id="reviews" class="reviews-section">
          <h2 class="section-title">
            Rese침as de la comunidad
            <span class="section-title__count">({{ reviews().length }})</span>
          </h2>

          @if (isLoadingReviews()) {
            <div class="loading-state">
              <app-spinner></app-spinner>
              <app-alert
                type="info"
                message="Cargando rese침as..."
              ></app-alert>
            </div>
          } @else if (reviews().length === 0) {
            <app-alert
              type="info"
              title="No hay rese침as a칰n"
              message="S칠 el primero en compartir tu opini칩n sobre este 치lbum"
            ></app-alert>
          } @else {
            <app-accordion
              [items]="reviewsAccordionItems()"
              mode="single">
            </app-accordion>
          }
        </section>

      </main>
    </div>
  } @else {
    <div class="loading-state loading-state--fullpage">
      <app-spinner></app-spinner>
      <app-alert
        type="info"
        message="Cargando 치lbum..."
      ></app-alert>
    </div>
  }
</div>
