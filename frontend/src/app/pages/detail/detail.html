<div class="detail">
  @if (item(); as itemData) {
    <div class="detail__container">

      <!-- ===================================================
           COLUMNA IZQUIERDA: INFO DEL ÁLBUM (1/3)
           MVP: Foto, Nombre, Artista, Rating, Lista, Stats, Género
           =================================================== -->
      <aside class="detail__sidebar">
        <div class="detail-card">
          <!-- Cover del álbum - LCP element -->
          <div class="detail-card__cover">
            <img
              [src]="itemCoverUrl()"
              [alt]="itemTitle()"
              class="detail-card__image"
              width="500"
              height="500"
              fetchpriority="high"
            />
          </div>

          <!-- Info básica -->
          <div class="detail-card__info">
            <!-- Nombre del álbum/artista/canción -->
            <h1 class="detail-card__title">{{ itemTitle() }}</h1>

            <!-- Nombre del artista (solo para álbumes y canciones) -->
            @if (itemArtist()) {
              <p class="detail-card__artist" (click)="goToArtist(itemArtistId())">
                {{ itemArtist() }}
              </p>
            }

            <!-- Tu puntuación - Selector de estrellas interactivo -->
            <div class="detail-card__user-rating">
              <h3 class="detail-card__section-title">Tu puntuación</h3>
              <app-rating
                [rating]="userRating()"
                [interactive]="isInUserList()"
                size="large"
                (ratingChange)="setRating($event)"
              />
              @if (!isLoggedIn()) {
                <p class="detail-card__rating-message detail-card__rating-message--hint">
                  Inicia sesión para puntuar
                </p>
              } @else if (needsListFirst()) {
                <p class="detail-card__rating-message detail-card__rating-message--warning">
                  Añade el álbum a tu lista para puntuarlo
                </p>
              } @else if (hasUserRated()) {
                <p class="detail-card__rating-message">
                  Has puntuado con {{ userRating() }} estrella{{ userRating() !== 1 ? 's' : '' }}
                </p>
              } @else if (isInUserList()) {
                <p class="detail-card__rating-message detail-card__rating-message--hint">
                  Haz clic para puntuar
                </p>
              } @else {
                <p class="detail-card__rating-message detail-card__rating-message--hint">
                  Añade a tu lista primero
                </p>
              }
            </div>

            <!-- Botón estado lista -->
            <div class="detail-card__list-action">
              <app-button
                [variant]="isInUserList() ? 'secondary' : 'primary'"
                size="md"
                [fullWidth]="true"
                (clicked)="toggleUserList()"
              >
                @if (isInUserList()) {
                  ✓ En mi lista
                } @else {
                  + Añadir a mi lista
                }
              </app-button>
            </div>

            <!-- Estadísticas generales -->
            <div class="detail-card__stats">
              <h3 class="detail-card__section-title">Estadísticas</h3>
              <div class="detail-card__stats-grid">
                <div class="stat-item">
                  <span class="stat-item__value">{{ stats().averageRating | number:'1.1-1' }}</span>
                  <span class="stat-item__label">Promedio</span>
                </div>
                <div class="stat-item">
                  <span class="stat-item__value">{{ stats().totalRatings }}</span>
                  <span class="stat-item__label">Puntuaciones</span>
                </div>
                <div class="stat-item">
                  <span class="stat-item__value">{{ stats().totalReviews }}</span>
                  <span class="stat-item__label">Reseñas</span>
                </div>
              </div>
            </div>

            <!-- Género - Badge -->
            @if (itemGenre()) {
              <div class="detail-card__genre">
                <h3 class="detail-card__section-title">Género</h3>
                <app-badge [text]="itemGenre()" variant="secondary" size="md"></app-badge>
              </div>
            }
          </div>
        </div>
      </aside>

      <!-- ===================================================
           COLUMNA DERECHA: RESEÑA Y TABS (2/3)
           MVP: Mi reseña, Botón escribir/editar, Tabs (Info, Canciones, Reseñas)
           =================================================== -->
      <main class="detail__content">

        <!-- SECCIÓN: MI RESEÑA -->
        <section class="my-review-section">
          <h2 class="section-title">Mi reseña</h2>

          @if (!isLoggedIn()) {
            <!-- Usuario no autenticado - mostrar mensaje informativo -->
            <app-alert
              type="warning"
              title="Inicia sesión para escribir reseñas"
              message="Debes estar registrado para compartir tu opinión sobre este álbum."
            ></app-alert>
            <div class="my-review-section__guest-actions">
              <app-button
                variant="primary"
                size="md"
                (clicked)="openLoginModal()"
              >
                Iniciar sesión
              </app-button>
              <app-button
                variant="secondary"
                size="md"
                (clicked)="openRegisterModal()"
              >
                Registrarse
              </app-button>
            </div>
          } @else if (!isInUserList()) {
            <!-- Usuario autenticado pero álbum no está en lista -->
            <app-alert
              type="info"
              title="Añade el álbum a tu lista"
              message="Debes añadir este álbum a tu lista de escuchados antes de poder escribir una reseña."
            ></app-alert>
          } @else if (!hasUserReview()) {
            <!-- Usuario autenticado, álbum en lista, pero sin reseña -->
            <app-alert
              type="info"
              message="No has escrito aún una reseña"
            ></app-alert>
          } @else {
            <!-- Existe reseña del usuario -->
            <div class="my-review">
              <div class="my-review__header">
                <span class="my-review__rating">{{ getStarsDisplay(userReview()!.rating) }}</span>
                <span class="my-review__date">{{ formatDate(userReview()!.date) }}</span>
              </div>
              <p class="my-review__text">{{ userReview()!.text }}</p>
            </div>
          }

          <!-- Botón escribir/editar reseña (solo para usuarios autenticados con álbum en lista) -->
          @if (isLoggedIn() && isInUserList() && !isWritingReview()) {
            <app-button
              variant="primary"
              size="md"
              [fullWidth]="true"
              (clicked)="startWritingReview()"
              class="my-review-section__button"
            >
              {{ hasUserReview() ? 'Editar reseña' : 'Escribir reseña' }}
            </app-button>
          } @else if (isLoggedIn() && isInUserList() && isWritingReview()) {
            <!-- Formulario de reseña -->
            <div class="review-form">
              <h3 class="review-form__title">{{ hasUserReview() ? 'Edita tu reseña' : 'Escribe tu reseña' }}</h3>

              <!-- Selector de puntuación integrado en el formulario -->
              <div class="review-form__rating">
                <label class="review-form__rating-label">Tu puntuación (opcional):</label>
                <app-rating
                  [rating]="userRating()"
                  [interactive]="true"
                  size="medium"
                  (ratingChange)="setRating($event)"
                />
              </div>

              <app-form-textarea
                [(ngModel)]="reviewText"
                placeholder="Comparte tu opinión (mínimo 3 caracteres)..."
                [rows]="5"
              ></app-form-textarea>

              <div class="review-form__footer">
                <span class="review-form__counter">
                  {{ reviewText().length }} caracteres
                  @if (reviewText().length < 3) {
                    <span class="review-form__counter--warning">(mínimo 3)</span>
                  }
                </span>

                <div class="review-form__actions">
                  <app-button variant="secondary" size="md" (clicked)="cancelReview()">
                    Cancelar
                  </app-button>
                  <app-button
                    variant="primary"
                    size="md"
                    [disabled]="!canSubmitReview()"
                    (clicked)="submitReview()"
                  >
                    Publicar
                  </app-button>
                </div>
              </div>
            </div>
          }
        </section>

        <!-- TABS: Información, Canciones, Reseñas -->
        <section class="detail-tabs-section">
          <app-tabs
            [tabs]="detailTabs()"
            [activeTabId]="activeTabId()"
            (tabChange)="onTabChange($event)"
          ></app-tabs>

          <!-- TAB: Información -->
          @if (isInfoTab()) {
            <div class="tab-content tab-content--info" id="tabpanel-info" role="tabpanel">
              <h3 class="tab-content__title">Descripción</h3>
              <p class="tab-content__description">{{ itemDescription() }}</p>
            </div>
          }

          <!-- TAB: Canciones -->
          @if (isTracksTab()) {
            <div class="tab-content tab-content--tracks" id="tabpanel-tracks" role="tabpanel">
              <div class="tracklist">
                @for (track of trackList(); track track.id) {
                  <div class="track-item">
                    <span class="track-item__number">{{ track.number }}.</span>
                    <span class="track-item__title">{{ track.title }}</span>
                    <span class="track-item__duration">{{ track.duration }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- TAB: Reseñas -->
          @if (isReviewsTab()) {
            <div class="tab-content tab-content--reviews" id="tabpanel-reviews" role="tabpanel">
              <h3 class="tab-content__title">
                Reseñas de la comunidad
                <span class="tab-content__count">({{ reviews().length }})</span>
              </h3>

              @if (displayedReviews().length === 0 && !isLoadingMoreReviews()) {
                <app-alert
                  type="info"
                  title="No hay reseñas aún"
                  message="Sé el primero en compartir tu opinión"
                ></app-alert>
              } @else {
                <div class="reviews-list">
                  @for (review of displayedReviews(); track review.id) {
                    <div class="review-card">
                      <div class="review-card__header">
                        <img
                          [src]="review.userAvatar"
                          [alt]="review.userName || 'Usuario'"
                          class="review-card__avatar"
                          (click)="goToUser(review.userId)"
                        />
                        <div class="review-card__user-info">
                          <h5 class="review-card__user-name" (click)="goToUser(review.userId)">
                            {{ review.userName || review.username }}
                          </h5>
                          <div class="review-card__meta">
                            <span class="review-card__rating">{{ getStarsDisplay(review.rating) }}</span>
                            <span class="review-card__date">{{ formatDate(review.date) }}</span>
                          </div>
                        </div>
                      </div>
                      <p class="review-card__content">{{ review.content }}</p>
                    </div>
                  }
                </div>

                <!-- Infinite Scroll -->
                <app-infinite-scroll
                  [loading]="isLoadingMoreReviews()"
                  [hasMore]="hasMoreReviews()"
                  (loadMore)="loadMoreReviews()"
                  loadingText="Cargando más reseñas..."
                  endText="No hay más reseñas"
                ></app-infinite-scroll>
              }
            </div>
          }
        </section>

      </main>
    </div>
  } @else {
    <!-- Loading state -->
    <div class="loading-state loading-state--fullpage">
      <app-spinner></app-spinner>
      <app-alert
        type="info"
        message="Cargando..."
      ></app-alert>
    </div>
  }
</div>
